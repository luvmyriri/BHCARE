
# ============= PASSWORD RESET ENDPOINTS =============
@app.route("/forgot-password", methods=["POST"])
def forgot_password():
    """Send password reset email"""
    try:
        data = request.json
        email = data.get('email')
        
        if not email:
            return jsonify({"error": "Email is required"}), 400
        
        # Check if user exists
        conn = get_db()
        cur = conn.cursor()
        cur.execute("SELECT id, first_name FROM users WHERE email = %s", (email,))
        user = cur.fetchone()
        cur.close()
        conn.close()
        
        # Always return success to prevent email enumeration
        if not user:
            return jsonify({"message": "If that email exists, a password reset link has been sent."}), 200
        
        # Generate and store reset token
        token = generate_reset_token()
        store_reset_token(email, token)
        
        # Send reset email
        try:
            send_password_reset_email(mail, email, token)
            print(f"[PASSWORD RESET] Email sent to {email}")
        except Exception as e:
            print(f"[PASSWORD RESET] Error sending email: {str(e)}")
            return jsonify({"error": "Failed to send reset email. Please try again later."}), 500
        
        return jsonify({"message": "If that email exists, a password reset link has been sent."}), 200
        
    except Exception as e:
        print(f"[PASSWORD RESET] Error: {str(e)}")
        return jsonify({"error": "An error occurred"}), 500

@app.route("/validate-reset-token/<token>", methods=["GET"])
def validate_token(token):
    """Validate if reset token is valid"""
    try:
        email = validate_reset_token(token)
        if email:
            return jsonify({"valid": True, "email": email}), 200
        else:
            return jsonify({"valid": False, "error": "Invalid or expired token"}), 400
    except Exception as e:
        return jsonify({"valid": False, "error": str(e)}), 500

@app.route("/reset-password", methods=["POST"])
def reset_password():
    """Reset password using valid token"""
    try:
        data = request.json
        token = data.get('token')
        new_password = data.get('password')
        
        if not token or not new_password:
            return jsonify({"error": "Token and new password are required"}), 400
        
        # Validate token
        email = validate_reset_token(token)
        if not email:
            return jsonify({"error": "Invalid or expired reset token"}), 400
        
        # Password validation
        if len(new_password) < 8:
            return jsonify({"error": "Password must be at least 8 characters"}), 400
        
        # Hash new password
        hashed = bcrypt.generate_password_hash(new_password).decode('utf-8')
        
        # Update password in database
        conn = get_db()
        cur = conn.cursor()
        cur.execute("UPDATE users SET password_hash = %s WHERE email = %s RETURNING id", (hashed, email))
        updated = cur.fetchone()
        conn.commit()
        cur.close()
        conn.close()
        
        if not updated:
            return jsonify({"error": "User not found"}), 404
        
        # Invalidate the token (single use)
        invalidate_reset_token(token)
        
        print(f"[PASSWORD RESET] Password successfully reset for {email}")
        return jsonify({"message": "Password has been reset successfully"}), 200
        
    except Exception as e:
        print(f"[PASSWORD RESET] Error: {str(e)}")
        return jsonify({"error": "An error occurred"}), 500

